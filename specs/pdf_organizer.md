# Google Drive PDF整理・提出支援ツール  
## 要件定義書（完全版 v7 / 将来拡張前提）

作成日：2025-12-20  
作成者：初瀬  
対象：社内オペレーター向け（Google Workspace）  
ステータス：MVP開発着手可

---

## 1. 背景・目的

当社では、住宅ローン審査に関連するPDF書類（要配慮個人情報を含む）を  
Google Drive を基盤として管理・提出している。

現状の課題は以下。

- PDFの回転・並び替え・削除・結合を行うために  
  **一度ローカルにダウンロードする運用**が残っている
- ローカル保存による情報漏えいリスク
- 編集〜提出までの作業が煩雑で属人化している

本ツールは、

- **Google Drive中心の業務文脈を崩さず**
- **ローカル保存を不要にし**
- **提出用PDF作成を楽にする**

ことをMVPの目的とする。

---

## 2. 将来像（本要件の位置づけ）

本ツールは以下の発展を前提とした「基盤ツール」である。

- 機微情報の自動／半自動マスキング
- 金融機関提出用メールの自動作成（Gmail下書き）
- 提出履歴・監査ログの高度化

ただし **MVPでは実装しない**。  
MVPはあくまで「提出用PDFを安全に作る」ことに集中する。

---

## 3. MVPの価値命題（確定）

1. Google Drive上のPDFを **ローカル保存せずに整理**できる  
2. 複数PDFを結合し、**提出用の1ファイルを作成できる**  
3. **起動元フォルダに保存**され、業務動線が分断されない  
4. 権限エラー時も **フォールバックで作業が止まらない**

---

## 4. 用語定義

| 用語 | 定義 |
|---|---|
| 起動元フォルダ | Drive上でPDFを選択して起動した際の親フォルダ |
| 提出用PDF | 本ツールで整理・結合された最終成果物 |
| ジョブ | PDF整理1回分の処理単位 |
| フォールバック | 起動元フォルダに保存できない場合の代替保存 |

---

## 5. 対象ユーザー・利用範囲

- 利用者：社内オペレーター
- 認証：Google Workspaceアカウント
- 対象Drive：
  - マイドライブ
  - 共有フォルダ
  - 共有ドライブ

---

## 6. セキュリティ前提（重要）

### 6.1 データ取り扱い方針

- 正本データは **常にGoogle Drive上**
- ユーザーに明示的なダウンロード導線を提供しない
- ブラウザ上で扱うデータは **一時メモリのみ**

### 6.2 技術的制御

- LocalStorage / IndexedDB に本文保存禁止
- Cache-Control: no-store
- Service Workerによるキャッシュ禁止
- CSPで外部送信先を制限

※ ブラウザメモリ上の一時展開については  
　**社内情報セキュリティレビュー承認をリリース条件とする**

---

## 7. 起動方式・UI導線

### 7.1 起動方式

- 既存社内Chrome拡張に機能追加
- Drive画面から以下で起動可能
  - 右クリックメニュー「PDF整理」
  - ツールバーのボタン

### 7.2 表示方式

- **別タブで新規ページを開く**
- Driveページはそのまま残る
- 作業完了後は「閉じる」ボタンでタブを閉じてDriveに戻る

### 7.3 起動時取得情報

- 選択されたPDFの fileId（複数）
- 起動元フォルダID（parentFolderId）
- driveId / supportsAllDrives 情報

---

## 8. OAuth / Drive API設計（確定）

### 8.1 OAuthスコープ

- 原則：`drive.file`
- 補助：`drive.metadata.readonly`（必要時）

### 8.2 保存仕様（パターンC）

#### 通常フロー
- parentFolderId を指定して files.create
- 起動元フォルダに新規PDFを保存

#### 例外フロー（権限エラー時）
- フォルダPickerを表示
- ユーザーが明示的に保存先を選択
- 選択フォルダは drive.file の対象となる

---

## 9. 機能要件（MVP）

### 9.1 PDF編集機能

- 複数PDFの結合
- ページの並び替え（D&D）
- ページ回転（90度単位）
- ページ削除
- Undo：直前1回

※ 上書き保存はしない（新規作成のみ）

---

## 10. 出力仕様

### 10.1 保存先

- 原則：起動元フォルダ
- 例外：フォールバックで選択したフォルダ

### 10.2 命名規則

提出用_{起動元フォルダ名}_{YYYYMMDD_HHMM}.pdf

### 10.3 保存後の動作

- 保存完了メッセージを表示
- 「閉じてDriveに戻る」ボタンを表示
- ボタン押下でタブを閉じる（`window.close()`）

---

## 11. サイズ制限

- 合計300MBまで
- 超過時はエラー表示（MVP）

### 11.1 根拠確定タスク（必須）

- 実業務データ（直近1か月）を分析
- 300MB超件数とカバー率を算出
- 数値根拠を文書化

---

## 12. エラーハンドリング

| 事象 | 挙動 |
|---|---|
| 保存権限なし | フォルダPicker表示 |
| Drive API失敗 | リトライ（最大2回） |
| 認証切れ | 再認証 |
| ブラウザクラッシュ | 編集内容消失（MVP仕様） |

---

## 13. ジョブ管理（将来拡張前提）

PDF整理1回を「ジョブ」として扱う。

最低限記録する項目：

- jobId
- input fileIds
- output fileId
- 起動元フォルダID
- 実行者
- 実行日時
- 操作履歴（並び替え／削除／回転）

※ MVPでは Cloud Logging に記録

---

## 14. 将来拡張①：機微情報マスキング（対象外／設計前提）

### 想定フェーズ
- Phase 2：OCR＋候補ハイライト＋人手確定
- Phase 3：自動確定領域の拡張

### 設計前提
- PDF生成処理とは独立した後段処理
- Drive fileId を入出力にする
- ブラウザ処理が重い場合はサーバ側へ移行可能

---

## 15. 将来拡張②：提出メール自動作成（対象外／設計前提）

### 想定フェーズ
- Phase 2：Gmail下書き作成
- Phase 3：承認後送信

### 設計前提
- ジョブIDから提出PDF・案件情報を参照
- 送信は原則人が実行（自動送信しない）

---

## 16. テスト要件

- 単体テスト：PDF操作、命名、サイズ制限
- 結合テスト：Drive API（共有ドライブ含む）
- UAT：
  - 通常保存
  - 権限エラー → フォールバック
  - 大容量PDF

---

## 17. リリース条件（Done定義）

- Driveから1操作で起動できる
- ローカル保存不要でPDF整理が完結する
- 原則起動元フォルダに保存される
- 例外時も作業が止まらない
- セキュリティレビュー承認済み
- テスト完了

---

## 18. MVPで「やらないこと」

- PDFへの直接書き込み編集
- 自動マスキング
- メール自動送信
- PDFの上書き保存
- 履歴の永続DB保存

---
