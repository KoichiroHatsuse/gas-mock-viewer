<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AI„ÉÅ„Çß„ÉÉ„ÇØÊ©üÊßã„É¢„ÉÉ„ÇØ</title>
  <style>
    :root {
      --primary: #1a7cc4;
      --primary-dark: #155d94;
      --bg: #f5f6f8;
      --sidebar-bg: #ffffff;
      --chat-bg: #f0f2f5;
      --white: #ffffff;
      --text: #333333;
      --text-muted: #666666;
      --border: #e0e0e0;
      --danger: #dc3545;
      --warning: #ffc107;
      --success: #28a745;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Hiragino Kaku Gothic ProN", "Noto Sans JP", system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ===== „Éò„ÉÉ„ÉÄ„Éº ===== */
    .header {
      background: var(--primary);
      color: white;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }
    .header-logo {
      font-size: 20px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .header-logo svg {
      width: 28px;
      height: 28px;
    }
    .header-badge {
      background: rgba(255,255,255,0.2);
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 12px;
      margin-left: auto;
    }

    /* ===== „É°„Ç§„É≥„É¨„Ç§„Ç¢„Ç¶„Éà ===== */
    .main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* ===== „Çµ„Ç§„Éâ„Éê„Éº ===== */
    .sidebar {
      width: 320px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    .sidebar-header {
      padding: 12px;
      border-bottom: 1px solid var(--border);
    }
    .sidebar-search {
      display: flex;
      gap: 8px;
    }
    .sidebar-search input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 14px;
    }
    .sidebar-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
    }
    .sidebar-tab {
      flex: 1;
      padding: 10px;
      text-align: center;
      font-size: 13px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }
    .sidebar-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      font-weight: bold;
    }
    .chat-list {
      flex: 1;
      overflow-y: auto;
    }
    .chat-item {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      display: flex;
      gap: 10px;
    }
    .chat-item:hover {
      background: #f5f7fa;
    }
    .chat-item.active {
      background: #e8f4fc;
    }
    .chat-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      flex-shrink: 0;
    }
    .chat-info {
      flex: 1;
      min-width: 0;
    }
    .chat-name {
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .chat-preview {
      font-size: 12px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-top: 2px;
    }
    .chat-badge {
      background: var(--danger);
      color: white;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 10px;
    }

    /* ===== „ÉÅ„É£„ÉÉ„Éà„Ç®„É™„Ç¢ ===== */
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--chat-bg);
    }
    .chat-header {
      background: var(--white);
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .chat-header-title {
      font-size: 16px;
      font-weight: 600;
    }
    .chat-header-sub {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* ===== „É°„ÉÉ„Çª„Éº„Ç∏„Ç®„É™„Ç¢ ===== */
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .message {
      display: flex;
      gap: 10px;
      max-width: 70%;
    }
    .message.customer {
      align-self: flex-start;
    }
    .message.operator {
      align-self: flex-end;
      flex-direction: row-reverse;
    }
    .message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      flex-shrink: 0;
    }
    .message.operator .message-avatar {
      background: var(--primary);
      color: white;
    }
    .message-content {
      background: var(--white);
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .message.operator .message-content {
      background: #dcf8c6;
    }
    .message-time {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* ===== ÂÖ•Âäõ„Ç®„É™„Ç¢ ===== */
    .input-area {
      background: var(--white);
      padding: 16px 20px;
      border-top: 1px solid var(--border);
    }
    .input-wrapper {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }
    .input-box {
      flex: 1;
      position: relative;
    }
    .input-box textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      resize: none;
      font-family: inherit;
      line-height: 1.5;
    }
    .input-box textarea:focus {
      outline: none;
      border-color: var(--primary);
    }
    .send-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    .send-btn:hover {
      background: var(--primary-dark);
    }
    .send-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* ===== „ÉÜ„Çπ„ÉàÂÖ•Âäõ„Éú„Çø„É≥ ===== */
    .test-inputs {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px dashed var(--border);
    }
    .test-inputs-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }
    .test-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .test-btn {
      background: #f0f0f0;
      border: 1px solid var(--border);
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .test-btn:hover {
      background: #e0e0e0;
    }
    .test-btn.high { border-color: var(--danger); color: var(--danger); }
    .test-btn.medium { border-color: #e67700; color: #e67700; }
    .test-btn.low { border-color: var(--success); color: var(--success); }

    /* ===== AI„ÉÅ„Çß„ÉÉ„ÇØ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó ===== */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .popup-overlay.show {
      display: flex;
    }
    .popup {
      background: var(--white);
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    .popup-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .popup-header.high { background: #fde8e8; }
    .popup-header.medium { background: #fff3cd; }
    .popup-header.low { background: #d4edda; }
    .popup-icon {
      font-size: 24px;
    }
    .popup-title {
      font-size: 18px;
      font-weight: bold;
    }
    .popup-body {
      padding: 20px;
    }
    .popup-section {
      margin-bottom: 16px;
    }
    .popup-section:last-child {
      margin-bottom: 0;
    }
    .popup-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 6px;
      font-weight: 600;
    }
    .popup-warning {
      font-size: 14px;
      line-height: 1.6;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    .popup-categories {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .popup-category {
      background: #e9ecef;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
    }
    .popup-expressions {
      background: #fff3cd;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 13px;
    }
    .popup-expressions mark {
      background: #ffeb3b;
      padding: 0 2px;
    }
    .alternatives-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .alternative-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    .alternative-text {
      flex: 1;
      font-size: 13px;
      line-height: 1.5;
    }
    .alternative-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
    }
    .alternative-btn:hover {
      background: var(--primary-dark);
    }
    .popup-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    .popup-btn {
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 500;
    }
    .popup-btn.secondary {
      background: white;
      border: 1px solid var(--border);
      color: var(--text);
    }
    .popup-btn.secondary:hover {
      background: #f5f5f5;
    }
    .popup-btn.primary {
      background: var(--danger);
      border: none;
      color: white;
    }
    .popup-btn.primary:hover {
      background: #c82333;
    }

    /* ===== „É≠„Éº„Éá„Ç£„É≥„Ç∞ ===== */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .loading-overlay.show {
      display: flex;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-text {
      margin-top: 12px;
      font-size: 14px;
      color: var(--text-muted);
    }

    /* ===== „Éõ„Éº„É†„Éú„Çø„É≥ ===== */
    .home-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--white);
      border: 1px solid var(--border);
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 100;
      text-decoration: none;
      color: var(--text);
    }
    .home-btn:hover {
      background: #f5f5f5;
    }

    /* ===== „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏ ===== */
    .error-toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--danger);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
      z-index: 1001;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .error-toast.show {
      display: block;
    }
  </style>
</head>
<body>
  <!-- „Éò„ÉÉ„ÉÄ„Éº -->
  <header class="header">
    <div class="header-logo">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 3L4 9v12h16V9l-8-6zm0 2.5L18 10v9H6v-9l6-4.5z"/>
        <path d="M12 14a2 2 0 100-4 2 2 0 000 4z"/>
      </svg>
      „ÉÄ„É≥„Éâ„É™
    </div>
    <span class="header-badge">AI„ÉÅ„Çß„ÉÉ„ÇØÊ©üÊßã „É¢„ÉÉ„ÇØ</span>
  </header>

  <!-- „É°„Ç§„É≥„É¨„Ç§„Ç¢„Ç¶„Éà -->
  <div class="main">
    <!-- „Çµ„Ç§„Éâ„Éê„Éº -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-search">
          <input type="text" placeholder="„ÉÅ„É£„ÉÉ„Éà„É´„Éº„É†„ÇíÊ§úÁ¥¢„Åô„Çã">
        </div>
      </div>
      <div class="sidebar-tabs">
        <div class="sidebar-tab active">„Åô„Åπ„Å¶</div>
        <div class="sidebar-tab">Êú™Ëøî‰ø°</div>
      </div>
      <div class="chat-list" id="chatList"></div>
    </aside>

    <!-- „ÉÅ„É£„ÉÉ„Éà„Ç®„É™„Ç¢ -->
    <main class="chat-area">
      <div class="chat-header">
        <div>
          <div class="chat-header-title" id="chatTitle">Â±±Áî∞Â§™ÈÉé Êßò</div>
          <div class="chat-header-sub">‰ΩèÂÆÖ„Éª‰∏çÂãïÁî£‰ºöÁ§æÊú¨Â∫ó1-1-1</div>
        </div>
      </div>

      <div class="messages" id="messages"></div>

      <div class="input-area">
        <div class="input-wrapper">
          <div class="input-box">
            <textarea id="messageInput" rows="3" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..."></textarea>
          </div>
          <button class="send-btn" id="sendBtn">ÈÄÅ‰ø°</button>
        </div>
        <div class="test-inputs">
          <div class="test-inputs-label">„ÉÜ„Çπ„ÉàÁî®ÂÖ•Âäõ‰æãÔºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÊåøÂÖ•Ôºâ</div>
          <div class="test-buttons" id="testButtons"></div>
        </div>
      </div>
    </main>
  </div>

  <!-- AI„ÉÅ„Çß„ÉÉ„ÇØ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó -->
  <div class="popup-overlay" id="popupOverlay">
    <div class="popup">
      <div class="popup-header" id="popupHeader">
        <span class="popup-icon" id="popupIcon">‚ö†Ô∏è</span>
        <span class="popup-title" id="popupTitle">„É™„Çπ„ÇØ„ÇíÊ§úÁü•„Åó„Åæ„Åó„Åü</span>
      </div>
      <div class="popup-body">
        <div class="popup-section">
          <div class="popup-label">Ê≥®ÊÑèÂñöËµ∑</div>
          <div class="popup-warning" id="popupWarning"></div>
        </div>
        <div class="popup-section">
          <div class="popup-label">Ê§úÁü•„Ç´„ÉÜ„Ç¥„É™</div>
          <div class="popup-categories" id="popupCategories"></div>
        </div>
        <div class="popup-section">
          <div class="popup-label">ÂïèÈ°å„ÅÆ„ÅÇ„ÇãË°®Áèæ</div>
          <div class="popup-expressions" id="popupExpressions"></div>
        </div>
        <div class="popup-section">
          <div class="popup-label">Êé®Â•®„Åï„Çå„ÇãË®Ä„ÅÑÊèõ„Åà</div>
          <div class="alternatives-list" id="alternativesList"></div>
        </div>
      </div>
      <div class="popup-footer">
        <button class="popup-btn secondary" id="editBtn">‰øÆÊ≠£„Åô„Çã</button>
        <button class="popup-btn primary" id="sendAnywayBtn">„Åì„ÅÆ„Åæ„ÅæÈÄÅ‰ø°</button>
      </div>
    </div>
  </div>

  <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞ -->
  <div class="loading-overlay" id="loadingOverlay">
    <div style="text-align: center;">
      <div class="loading-spinner"></div>
      <div class="loading-text">AI„ÉÅ„Çß„ÉÉ„ÇØ‰∏≠...</div>
    </div>
  </div>

  <!-- „Ç®„É©„Éº„Éà„Éº„Çπ„Éà -->
  <div class="error-toast" id="errorToast"></div>

  <!-- „Éõ„Éº„É†„Éú„Çø„É≥ -->
  <a class="home-btn" id="homeBtn">‚Üê „É¢„ÉÉ„ÇØ‰∏ÄË¶ß„Å´Êàª„Çã</a>

  <script>
    // ===== „Éá„Éº„Çø =====
    const chatRooms = [
      { id: 1, name: 'Â±±Áî∞Â§™ÈÉé 081301', company: '‰ΩèÂÆÖ„Éª‰∏çÂãïÁî£‰ºöÁ§æÊú¨Â∫ó1-1-1', unread: 0 },
      { id: 2, name: 'Áî∞‰∏≠„ÉÜ„Çπ„Éà2', company: '‰ΩèÂÆÖ„Éª‰∏çÂãïÁî£‰ºöÁ§æÊú¨Â∫ó1-1-1', unread: 0 },
      { id: 3, name: '„Çπ„Ç±„Ç∏„É•„Éº„É´Â§âÊõ¥„ÉÜ„Çπ„Éà', company: '‰ΩèÂÆÖ„Éª‰∏çÂãïÁî£‰ºöÁ§æÊú¨Â∫ó1-1-1', unread: 1 },
      { id: 4, name: 'Áî∞‰∏≠„Ç≥„Ç∞„Éã„ÉÜ„Çπ„Éà', company: '‰ΩèÂÆÖ„Éª‰∏çÂãïÁî£‰ºöÁ§æÊú¨Â∫ó1-1-1', unread: 1 },
      { id: 5, name: 'Âèó„ÅëÂÖ•„ÇåÂâç„ÉÜ„Çπ„Éà2', company: '‰ΩèÂÆÖ„Éª‰∏çÂãïÁî£‰ºöÁ§æÊú¨Â∫ó1-1-1', unread: 0 },
    ];

    const sampleMessages = [
      { type: 'customer', text: '„Åä‰∏ñË©±„Å´„Å™„Å£„Å¶„Åä„Çä„Åæ„Åô„ÄÇ‰ΩèÂÆÖ„É≠„Éº„É≥„ÅÆÂØ©Êüª„Å´„Å§„ÅÑ„Å¶Ë≥™Âïè„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ', time: '1Êúà5Êó• 10:30' },
      { type: 'operator', text: '„ÅäÂïè„ÅÑÂêà„Çè„Åõ„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ„Å©„ÅÆ„Çà„ÅÜ„Å™„ÅîË≥™Âïè„Åß„Åó„Çá„ÅÜ„ÅãÔºü', time: '1Êúà5Êó• 10:32' },
      { type: 'customer', text: 'ÁßÅ„ÅØ45Ê≠≥„ÅßÂçòË∫´„Å™„ÅÆ„Åß„Åô„Åå„ÄÅÂØ©Êüª„Å´ÂΩ±Èüø„ÅØ„ÅÇ„Çä„Åæ„Åô„ÅãÔºü', time: '1Êúà5Êó• 10:35' },
    ];

    const testInputs = [
      { text: 'Áî∑ÊÄß„ÅÆÂçòË∫´ËÄÖ„ÅØÂØ©Êüª„ÅåÈÄö„Çä„Å´„Åè„ÅÑ„Åß„Åô', risk: 'high' },
      { text: '„Åì„ÅÆÈäÄË°å„ÅØÂé≥„Åó„Åô„Åé„Çã„ÅÆ„Åß„ÄÅ‰ªñ„ÇíÊ§úË®é„Åó„Åæ„Åó„Çá„ÅÜ', risk: 'medium' },
      { text: 'Áµ∂ÂØæ„Å´ÂØ©Êüª„ÅØÈÄö„Çä„Åæ„Åõ„Çì', risk: 'high' },
      { text: 'ÊäïË≥áÁî®„Å†„Å®ÊÄù„Çè„Çå„Çã„Å®NG„Åß„Åô', risk: 'medium' },
      { text: '‰∏ÄÁï™„ÅÑ„ÅÑÈáëÂà©„ÅåÂá∫„Çã„Å®ÊÄù„ÅÑ„Åæ„Åô', risk: 'medium' },
      { text: 'ÂØ©Êüª„Åß„ÅØÂ±Ö‰ΩèÂÆüÊÖã„ÇíÁ¢∫Ë™ç„Åï„Çå„Åæ„Åô', risk: 'low' },
    ];

    // ===== Áä∂ÊÖã =====
    let messages = [...sampleMessages];
    let currentCheckResult = null;
    let pendingMessage = '';

    // ===== DOMË¶ÅÁ¥† =====
    const chatListEl = document.getElementById('chatList');
    const messagesEl = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const testButtonsEl = document.getElementById('testButtons');
    const popupOverlay = document.getElementById('popupOverlay');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const errorToast = document.getElementById('errorToast');
    const homeBtn = document.getElementById('homeBtn');

    // ===== ÂàùÊúüÂåñ =====
    function init() {
      renderChatList();
      renderMessages();
      renderTestButtons();
      setupEventListeners();
      setupHomeButton();
    }

    function setupHomeButton() {
      google.script.run
        .withSuccessHandler(function(url) {
          homeBtn.href = url;
          homeBtn.target = '_top';
        })
        .getWebAppUrl();
    }

    function renderChatList() {
      chatListEl.innerHTML = chatRooms.map((room, i) => `
        <div class="chat-item ${i === 0 ? 'active' : ''}" data-id="${room.id}">
          <div class="chat-avatar">${room.name.charAt(0)}</div>
          <div class="chat-info">
            <div class="chat-name">${room.name}</div>
            <div class="chat-preview">${room.company}</div>
          </div>
          ${room.unread > 0 ? `<span class="chat-badge">${room.unread}</span>` : ''}
        </div>
      `).join('');
    }

    function renderMessages() {
      messagesEl.innerHTML = messages.map(msg => `
        <div class="message ${msg.type}">
          <div class="message-avatar">${msg.type === 'operator' ? 'OP' : 'ÂÆ¢'}</div>
          <div>
            <div class="message-content">${escapeHtml(msg.text)}</div>
            <div class="message-time">${msg.time}</div>
          </div>
        </div>
      `).join('');
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function renderTestButtons() {
      testButtonsEl.innerHTML = testInputs.map(input => `
        <button class="test-btn ${input.risk}" data-text="${escapeHtml(input.text)}">
          ${input.text.substring(0, 20)}...
        </button>
      `).join('');
    }

    function setupEventListeners() {
      // ÈÄÅ‰ø°„Éú„Çø„É≥
      sendBtn.addEventListener('click', handleSend);

      // Enter„Ç≠„Éº„ÅßÈÄÅ‰ø°ÔºàShift+Enter„ÅØÊîπË°åÔºâ
      messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleSend();
        }
      });

      // „ÉÜ„Çπ„Éà„Éú„Çø„É≥
      testButtonsEl.addEventListener('click', (e) => {
        if (e.target.classList.contains('test-btn')) {
          messageInput.value = e.target.dataset.text;
          messageInput.focus();
        }
      });

      // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó: ‰øÆÊ≠£„Åô„Çã
      document.getElementById('editBtn').addEventListener('click', () => {
        hidePopup();
        messageInput.focus();
      });

      // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó: „Åì„ÅÆ„Åæ„ÅæÈÄÅ‰ø°
      document.getElementById('sendAnywayBtn').addEventListener('click', () => {
        hidePopup();
        addMessage(pendingMessage);
      });
    }

    // ===== ÈÄÅ‰ø°Âá¶ÁêÜ =====
    async function handleSend() {
      const text = messageInput.value.trim();
      if (!text) return;

      pendingMessage = text;
      showLoading();

      try {
        const result = await checkWithAI(text);
        hideLoading();

        if (result.risk_level === 'low') {
          // „É™„Çπ„ÇØ‰Ωé: „Åù„ÅÆ„Åæ„ÅæÈÄÅ‰ø°
          addMessage(text);
        } else {
          // „É™„Çπ„ÇØÊ§úÁü•: „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË°®Á§∫
          currentCheckResult = result;
          showPopup(result);
        }
      } catch (error) {
        hideLoading();
        showError('AI„ÉÅ„Çß„ÉÉ„ÇØÊ©üËÉΩ„Åå‰∏ÄÊôÇÁöÑ„Å´Âà©Áî®„Åß„Åç„Åæ„Åõ„Çì');
        // „Ç®„É©„ÉºÊôÇ„ÇÇ„É°„ÉÉ„Çª„Éº„Ç∏„ÅØÈÄÅ‰ø°ÂèØËÉΩ
        addMessage(text);
      }
    }

    function checkWithAI(message) {
      return new Promise((resolve, reject) => {
        // „Çø„Ç§„É†„Ç¢„Ç¶„ÉàË®≠ÂÆöÔºà3ÁßíÔºâ
        const timeout = setTimeout(() => {
          reject(new Error('„Çø„Ç§„É†„Ç¢„Ç¶„Éà'));
        }, 3000);

        google.script.run
          .withSuccessHandler((result) => {
            clearTimeout(timeout);
            resolve(result);
          })
          .withFailureHandler((error) => {
            clearTimeout(timeout);
            reject(error);
          })
          .checkMessageWithAI(message);
      });
    }

    function addMessage(text) {
      const now = new Date();
      const time = `${now.getMonth() + 1}Êúà${now.getDate()}Êó• ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
      messages.push({ type: 'operator', text, time });
      renderMessages();
      messageInput.value = '';
    }

    // ===== „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó =====
    function showPopup(result) {
      const header = document.getElementById('popupHeader');
      const icon = document.getElementById('popupIcon');
      const title = document.getElementById('popupTitle');

      // „É™„Çπ„ÇØ„É¨„Éô„É´„Å´Âøú„Åò„Åü„Çπ„Çø„Ç§„É´
      header.className = 'popup-header ' + result.risk_level;
      if (result.risk_level === 'high') {
        icon.textContent = 'üö®';
        title.textContent = 'È´ò„É™„Çπ„ÇØ„ÇíÊ§úÁü•„Åó„Åæ„Åó„Åü';
      } else {
        icon.textContent = '‚ö†Ô∏è';
        title.textContent = 'Ê≥®ÊÑè„ÅåÂøÖË¶Å„Å™Ë°®Áèæ„Åå„ÅÇ„Çä„Åæ„Åô';
      }

      // ÂÜÖÂÆπË®≠ÂÆö
      document.getElementById('popupWarning').textContent = result.warning;
      document.getElementById('popupCategories').innerHTML = result.categories
        .map(cat => `<span class="popup-category">${escapeHtml(cat)}</span>`).join('');
      document.getElementById('popupExpressions').innerHTML = result.detected_expressions
        .map(exp => `<mark>${escapeHtml(exp)}</mark>`).join('„ÄÅ');

      // Ë®Ä„ÅÑÊèõ„ÅàÊ°à
      const altList = document.getElementById('alternativesList');
      altList.innerHTML = result.alternatives.map((alt, i) => `
        <div class="alternative-item">
          <span class="alternative-text">${escapeHtml(alt)}</span>
          <button class="alternative-btn" onclick="insertAlternative(${i})">ÊåøÂÖ•</button>
        </div>
      `).join('');

      popupOverlay.classList.add('show');
    }

    function hidePopup() {
      popupOverlay.classList.remove('show');
    }

    function insertAlternative(index) {
      if (currentCheckResult && currentCheckResult.alternatives[index]) {
        messageInput.value = currentCheckResult.alternatives[index];
        hidePopup();
        messageInput.focus();
      }
    }

    // ===== „É≠„Éº„Éá„Ç£„É≥„Ç∞„Éª„Ç®„É©„Éº =====
    function showLoading() {
      loadingOverlay.classList.add('show');
      sendBtn.disabled = true;
    }

    function hideLoading() {
      loadingOverlay.classList.remove('show');
      sendBtn.disabled = false;
    }

    function showError(message) {
      errorToast.textContent = message;
      errorToast.classList.add('show');
      setTimeout(() => errorToast.classList.remove('show'), 3000);
    }

    // ===== „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ =====
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞ÔºàonclickÁî®Ôºâ
    window.insertAlternative = insertAlternative;

    // ÂàùÊúüÂåñÂÆüË°å
    init();
  </script>
</body>
</html>
