<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PDFæ•´ç†ãƒ„ãƒ¼ãƒ«ï¼ˆDriveé¢¨ãƒ¢ãƒƒã‚¯ï¼‰</title>
  <style>
    :root{
      --bg:#f6f8fc;
      --card:#ffffff;
      --line:#e3e7f1;
      --text:#1f2a44;
      --muted:#5d6b89;
      --blue:#1a73e8;
      --blue2:#174ea6;
      --bad:#d93025;
      --warn:#f29900;
      --ok:#188038;
      --shadow: 0 6px 18px rgba(18,38,63,.08);
      --radius: 16px;
      --radius2: 12px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    /* --- Drive-like shell --- */
    .topbar{
      position:sticky; top:48px; z-index:20;
      display:flex; align-items:center; justify-content:space-between;
      height:64px;
      padding: 0 14px;
      background: var(--card);
      border-bottom:1px solid var(--line);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 260px;
    }
    .logoDot{
      width:28px;height:28px;border-radius:8px;
      background: linear-gradient(135deg, #34a853, #4285f4);
      box-shadow: var(--shadow);
    }
    .brand .name{font-weight:800}
    .search{
      flex:1;
      max-width: 720px;
      display:flex; align-items:center; gap:10px;
      background: #eef3fd;
      border:1px solid #e1e8fb;
      border-radius: 999px;
      padding: 10px 14px;
      margin: 0 14px;
    }
    .search input{
      border:none; outline:none; background:transparent;
      width:100%;
      font-size:14px;
    }
    .actions{
      display:flex; align-items:center; gap:10px;
    }
    .pill{
      display:flex; align-items:center; gap:8px;
      font-size:12px; color: var(--muted);
      padding: 8px 10px;
      border:1px solid var(--line);
      border-radius: 999px;
      background: var(--card);
      box-shadow: 0 2px 10px rgba(0,0,0,.03);
      white-space: nowrap;
    }
    .pill b{color: var(--text)}
    .btn{
      cursor:pointer;
      border:1px solid var(--line);
      background: var(--card);
      color: var(--text);
      padding:10px 12px;
      border-radius: 12px;
      font-weight:700;
      box-shadow: 0 2px 10px rgba(0,0,0,.03);
    }
    .btn.primary{
      background: linear-gradient(180deg, #2b7de9, var(--blue));
      color: #fff;
      border-color: rgba(26,115,232,.35);
    }
    .btn.danger{
      color: #fff;
      background: linear-gradient(180deg, #ea4335, var(--bad));
      border-color: rgba(217,48,37,.35);
    }
    .btn:disabled{opacity:.55; cursor:not-allowed}

    .shell{
      display:grid;
      grid-template-columns: 260px 420px 1fr;
      gap: 14px;
      padding: 14px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .panel{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height: calc(100vh - 64px - 48px - 28px);
    }
    .ph{
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-weight:800;
    }
    .sub{
      font-size:12px;
      color: var(--muted);
      font-weight:600;
    }
    .body{padding: 12px 14px;}

    /* --- Left nav (Drive-like) --- */
    .navItem{
      display:flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border-radius: 12px;
      color: var(--text);
      border:1px solid transparent;
    }
    .navItem.active{
      background: #e8f0fe;
      border-color: rgba(26,115,232,.25);
      color: var(--blue2);
      font-weight:800;
    }
    .navIcon{
      width:28px;height:28px;border-radius:10px;
      background:#f1f4fb;
      border:1px solid var(--line);
      display:flex; align-items:center; justify-content:center;
      font-family: var(--mono);
      color: var(--muted);
      font-size:12px;
    }

    /* --- File list mock (center) --- */
    .fileListHead{
      display:grid;
      grid-template-columns: 1.4fr .6fr .6fr;
      gap: 10px;
      padding: 10px 14px;
      color: var(--muted);
      font-size:12px;
      border-bottom:1px solid var(--line);
      background: #fbfcff;
    }
    .fileRow{
      display:grid;
      grid-template-columns: 1.4fr .6fr .6fr;
      gap: 10px;
      padding: 10px 14px;
      border-bottom:1px solid var(--line);
      align-items:center;
      cursor:pointer;
    }
    .fileRow:hover{background:#f7faff}
    .fileName{
      display:flex; align-items:center; gap:10px;
      font-weight:700;
    }
    .pdfIcon{
      width:28px;height:28px;border-radius:10px;
      background: rgba(217,48,37,.10);
      border:1px solid rgba(217,48,37,.22);
      display:flex; align-items:center; justify-content:center;
      color: var(--bad);
      font-weight:900;
      font-size:12px;
    }
    .small{font-size:12px; color: var(--muted); font-weight:600}

    /* --- Editor (right) --- */
    .editorGrid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 12px;
    }
    .hint{
      font-size:12px;
      color: var(--muted);
      line-height:1.45;
    }
    .thumbList{
      display:flex; flex-direction:column; gap:10px;
      padding: 12px 14px 14px;
    }
    .thumb{
      display:grid;
      grid-template-columns: 54px 1fr auto;
      gap:10px;
      align-items:center;
      padding:10px;
      border:1px solid var(--line);
      border-radius: 14px;
      user-select:none;
      background:#fff;
    }
    .thumb[aria-selected="true"]{
      outline:2px solid rgba(26,115,232,.35);
      background: #f3f8ff;
    }
    .pagebox{
      width:54px;height:54px;border-radius:12px;
      border:1px dashed rgba(93,107,137,.35);
      background: #fbfcff;
      display:flex; align-items:center; justify-content:center;
      position:relative;
      font-weight:900;
      color:#33466b;
    }
    .rotBadge{
      position:absolute; right:6px; bottom:6px;
      font-size:11px;
      color: var(--muted);
      background: rgba(31,42,68,.06);
      border:1px solid rgba(31,42,68,.10);
      padding:2px 6px;
      border-radius:999px;
      font-weight:700;
    }
    .meta{display:flex; flex-direction:column; gap:2px}
    .meta .name{font-weight:800}
    .meta .sub2{font-size:12px; color: var(--muted); font-weight:600}
    .iconbtn{
      cursor:pointer;
      width:36px;height:36px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:900;
      color:#33466b;
    }
    .iconbtn:hover{background:#f7faff}

    .toolRow{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      padding: 12px 14px;
      border-bottom:1px solid var(--line);
      background:#fbfcff;
    }
    .toolRow .sep{width:1px;height:28px;background:var(--line)}
    .msg{
      border-radius: 14px;
      padding: 10px 12px;
      border: 1px solid var(--line);
      background:#fff;
      font-size:13px;
      line-height:1.45;
      margin: 12px 14px 0;
      display:none;
    }
    .msg.ok{border-color: rgba(24,128,56,.25); background: rgba(24,128,56,.07)}
    .msg.bad{border-color: rgba(217,48,37,.25); background: rgba(217,48,37,.07)}
    .msg.warn{border-color: rgba(242,153,0,.25); background: rgba(242,153,0,.10)}
    .msg .closeTabBtn{
      margin-left: 12px;
      padding: 6px 14px;
      border-radius: 8px;
      border: 1px solid rgba(24,128,56,.35);
      background: var(--ok);
      color: #fff;
      font-weight: 700;
      cursor: pointer;
    }
    .msg .closeTabBtn:hover{background: #14662c}
    .previewWrap{padding: 12px 14px 14px;}
    .preview{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: #fff;
      padding: 14px;
      min-height: 440px;
      box-shadow: 0 2px 10px rgba(0,0,0,.03);
    }
    .pTitle{font-weight:900; font-size:16px; margin-bottom:6px}
    .pSub{font-size:12px; color: var(--muted); margin-bottom:14px}
    .sheet{
      width: min(560px, 82%);
      height: 330px;
      margin: 0 auto;
      border-radius: 14px;
      border: 1px solid rgba(93,107,137,.25);
      background: linear-gradient(180deg, #ffffff, #fbfcff);
      display:flex; align-items:center; justify-content:center;
      position:relative;
      transform-origin:center center;
    }
    .sheet::after{
      content:"";
      position:absolute; inset:10px;
      border:1px dashed rgba(93,107,137,.28);
      border-radius: 12px;
    }
    .big{
      font-size: 52px;
      font-weight: 1000;
      color:#2b3f6a;
      letter-spacing: 1px;
    }

    /* --- Modal (Folder Picker mock) --- */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(18,38,63,.45);
      display:none;
      align-items:center; justify-content:center;
      z-index:60;
    }
    .modal{
      width: min(760px, 92vw);
      border-radius: 18px;
      background:#fff;
      border:1px solid var(--line);
      box-shadow: 0 24px 70px rgba(18,38,63,.18);
      overflow:hidden;
    }
    .modalHeader{
      padding: 12px 14px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .folderGrid{
      padding: 14px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }
    .folder{
      cursor:pointer;
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      background:#fff;
    }
    .folder:hover{background:#f7faff}
    .folder .n{font-weight:900}
    .folder .p{font-size:12px; color: var(--muted); margin-top:2px; font-weight:600}

    @media (max-width: 1100px){
      .shell{grid-template-columns: 1fr}
      .panel{min-height: auto}
      .editorGrid{grid-template-columns: 1fr}
      .brand{min-width: 0}
      .search{display:none}
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <div class="logoDot"></div>
      <div>
        <div class="name">Driveï¼ˆãƒ¢ãƒƒã‚¯ï¼‰</div>
        <div class="sub">PDFæ•´ç†ãƒ„ãƒ¼ãƒ« UIåˆæ„ç”¨</div>
      </div>
    </div>

    <div class="search" aria-label="æ¤œç´¢ï¼ˆãƒ€ãƒŸãƒ¼ï¼‰">
      <span style="color:#6a7aa0;font-weight:900;">âŒ•</span>
      <input placeholder="ãƒ‰ãƒ©ã‚¤ãƒ–å†…ã‚’æ¤œç´¢ï¼ˆãƒ€ãƒŸãƒ¼ï¼‰" />
    </div>

    <div class="actions">
      <div class="pill">ä¿å­˜å…ˆï¼ˆåŸå‰‡ï¼‰: <b id="folderName">æ¡ˆä»¶_å±±ç”°æ§˜_2025-12</b></div>
      <div class="pill">åˆè¨ˆã‚µã‚¤ã‚º: <b id="totalSize">128MB</b>ï¼ˆä¸Šé™ 300MBï¼‰</div>
      <div class="pill">çŠ¶æ…‹: <b id="stateText">ç·¨é›†ä¸­</b></div>
      <button class="btn" id="togglePermissionBtn" title="ä¿å­˜æ™‚ã«æ¨©é™ã‚¨ãƒ©ãƒ¼ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ã‚’ç™ºç”Ÿã•ã›ã‚‹åˆ‡æ›¿">æ¨©é™ã‚¨ãƒ©ãƒ¼: OFF</button>
      <button class="btn danger" id="resetBtn">ãƒªã‚»ãƒƒãƒˆ</button>
      <button class="btn primary" id="saveBtn">ä¿å­˜</button>
    </div>
  </div>

  <div class="shell">
    <!-- Left nav -->
    <section class="panel" aria-label="å·¦ãƒŠãƒ“ï¼ˆDriveé¢¨ï¼‰">
      <div class="ph">ãƒŠãƒ“ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰ <span class="sub">Driveã£ã½ã„è¦‹ãŸç›®</span></div>
      <div class="body">
        <div class="navItem active"><div class="navIcon">ğŸ </div>ãƒã‚¤ãƒ‰ãƒ©ã‚¤ãƒ–</div>
        <div class="navItem"><div class="navIcon">ğŸ‘¥</div>å…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–</div>
        <div class="navItem"><div class="navIcon">â±</div>æœ€è¿‘ä½¿ç”¨</div>
        <div class="navItem"><div class="navIcon">â­</div>ã‚¹ã‚¿ãƒ¼ä»˜ã</div>
        <div class="navItem"><div class="navIcon">ğŸ—‘</div>ã‚´ãƒŸç®±</div>
        <div style="height:12px"></div>
        <div class="hint">
          <b>æƒ³å®š</b><br/>
          Driveä¸Šã§PDFã‚’è¤‡æ•°é¸æŠã—ã€å³ã‚¯ãƒªãƒƒã‚¯ or ä¸Šéƒ¨ãƒœã‚¿ãƒ³ã€ŒPDFæ•´ç†ã€ã§èµ·å‹•ã€‚
        </div>
      </div>
    </section>

    <!-- Center: file list -->
    <section class="panel" aria-label="ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ï¼ˆDriveé¢¨ï¼‰">
      <div class="ph">æ¡ˆä»¶_å±±ç”°æ§˜_2025-12 <span class="sub">ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ï¼ˆãƒ€ãƒŸãƒ¼ï¼‰</span></div>

      <div class="fileListHead">
        <div>åå‰</div><div>æ›´æ–°æ—¥</div><div>ã‚µã‚¤ã‚º</div>
      </div>

      <div class="fileRow" id="mockSelectHint" title="PDFã‚’è¤‡æ•°é¸æŠã—ã¦èµ·å‹•ã™ã‚‹æƒ³å®šï¼ˆã“ã“ã¯é™çš„ï¼‰">
        <div class="fileName"><div class="pdfIcon">PDF</div>æå‡ºæ›¸é¡_A.pdf</div>
        <div class="small">2025/12/19</div>
        <div class="small">42MB</div>
      </div>
      <div class="fileRow">
        <div class="fileName"><div class="pdfIcon">PDF</div>æå‡ºæ›¸é¡_B.pdf</div>
        <div class="small">2025/12/19</div>
        <div class="small">51MB</div>
      </div>
      <div class="fileRow">
        <div class="fileName"><div class="pdfIcon">PDF</div>æå‡ºæ›¸é¡_C.pdf</div>
        <div class="small">2025/12/19</div>
        <div class="small">35MB</div>
      </div>

      <div class="body">
        <div class="hint">
          <b>æ³¨è¨˜</b><br/>
          ã“ã“ã¯ã€ŒDriveç”»é¢ã®é›°å›²æ°—ã€å†ç¾ã§ã™ã€‚å®Ÿè£…ã§ã¯Driveã®é¸æŠçŠ¶æ…‹ã‹ã‚‰ fileId / parentFolderId ã‚’å–å¾—ã—ã¾ã™ã€‚
        </div>
      </div>
    </section>

    <!-- Right: editor -->
    <section class="panel" aria-label="ç·¨é›†ç”»é¢ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰">
      <div class="ph">PDFæ•´ç†ï¼ˆç·¨é›†ç”»é¢ï¼‰ <span class="sub">çµåˆãƒ»å›è»¢ãƒ»å‰Šé™¤ãƒ»ä¸¦ã³æ›¿ãˆãƒ»Undo</span></div>

      <div class="editorGrid">
        <div>
          <div class="ph" style="border-bottom:1px solid var(--line); border-radius:0; box-shadow:none; background:#fbfcff;">
            ãƒšãƒ¼ã‚¸ä¸€è¦§
            <span class="sub">D&D</span>
          </div>
          <div class="thumbList" id="thumbList"></div>
        </div>

        <div>
          <div class="toolRow">
            <button class="btn" id="rotateLeftBtn">â†º å·¦å›è»¢</button>
            <button class="btn" id="rotateRightBtn">â†» å³å›è»¢</button>
            <span class="sep"></span>
            <button class="btn danger" id="deleteBtn">ãƒšãƒ¼ã‚¸å‰Šé™¤</button>
            <button class="btn" id="undoBtn" disabled>Undo</button>
            <span class="sep"></span>
            <span class="hint">é¸æŠãƒšãƒ¼ã‚¸: <b id="selInfo">-</b></span>
          </div>

          <div id="banner" class="msg"></div>

          <div class="previewWrap">
            <div class="preview">
              <div class="pTitle" id="pTitle">ãƒšãƒ¼ã‚¸ 1</div>
              <div class="pSub" id="pSub">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ãƒ€ãƒŸãƒ¼ï¼ˆUIåˆæ„ç”¨ï¼‰</div>
              <div class="sheet" id="sheet">
                <div class="big" id="sheetText">1</div>
                <div class="rotBadge" id="rotBadge">0Â°</div>
              </div>

              <div style="height:14px"></div>
              <div class="hint">
                <b>ç¢ºèªãƒã‚¤ãƒ³ãƒˆ</b><br/>
                ãƒ»ä¸¦ã³æ›¿ãˆï¼ˆå·¦ï¼‰â†’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆå³ï¼‰ã®æ“ä½œæ„Ÿ<br/>
                ãƒ»ä¿å­˜ï¼ˆå³ä¸Šï¼‰â†’èµ·å‹•å…ƒãƒ•ã‚©ãƒ«ãƒ€ä¿å­˜<br/>
                ãƒ»æ¨©é™NGæ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆãƒ•ã‚©ãƒ«ãƒ€é¸æŠï¼‰ãŒè¨±å®¹ã‹
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Folder Picker Modal -->
  <div class="modalOverlay" id="modalOverlay" role="dialog" aria-modal="true" aria-label="ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€é¸æŠ">
    <div class="modal">
      <div class="modalHeader">
        <div>
          <div style="font-weight:900;">ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
          <div class="sub">èµ·å‹•å…ƒãƒ•ã‚©ãƒ«ãƒ€ã«ä¿å­˜ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆPERMISSION_DENIEDã®æƒ³å®šï¼‰</div>
        </div>
        <button class="btn" id="closeModalBtn">é–‰ã˜ã‚‹</button>
      </div>
      <div class="body">
        <div class="msg bad" style="display:block; margin:0 0 12px;">
          ã“ã®ãƒ•ã‚©ãƒ«ãƒ€ã«ã¯ä¿å­˜ã§ãã¾ã›ã‚“ã€‚ä¿å­˜å…ˆã‚’é¸ã³ç›´ã—ã¦ãã ã•ã„ã€‚
        </div>
        <div class="folderGrid" id="folderGrid"></div>
        <div class="hint" style="margin-top:12px;">
          â€» å®Ÿè£…ã§ã¯ Google Drive Picker ã‚’ä½¿ç”¨ã™ã‚‹æƒ³å®šã€‚ã“ã“ã§ã¯ç–‘ä¼¼ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§ã§ã™ã€‚
        </div>
      </div>
    </div>
  </div>

  <script>
    // --------- Mock Data ---------
    const initialPages = Array.from({length: 10}).map((_, i) => ({
      id: crypto.randomUUID(),
      pageNo: i + 1,
      rotation: 0,
      source: i < 4 ? "æå‡ºæ›¸é¡_A.pdf" : (i < 7 ? "æå‡ºæ›¸é¡_B.pdf" : "æå‡ºæ›¸é¡_C.pdf")
    }));

    const folders = [
      { id: "fld_001", name: "æ¡ˆä»¶_ä½è—¤æ§˜_2025-12", path: "ãƒã‚¤ãƒ‰ãƒ©ã‚¤ãƒ–/æ¡ˆä»¶/2025/12" },
      { id: "fld_002", name: "æ¡ˆä»¶_éˆ´æœ¨æ§˜_2025-12", path: "ãƒã‚¤ãƒ‰ãƒ©ã‚¤ãƒ–/æ¡ˆä»¶/2025/12" },
      { id: "fld_003", name: "ä½œæ¥­ç”¨_ä¸€æ™‚ãƒ•ã‚©ãƒ«ãƒ€", path: "æ¥­å‹™å…±é€š/ä½œæ¥­ç”¨" },
      { id: "fld_004", name: "å…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–_å¯©æŸ»æå‡º", path: "å…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–/å¯©æŸ»/æå‡º" },
    ];

    // --------- State ---------
    let pages = structuredClone(initialPages);
    let selectedId = pages[0]?.id ?? null;
    let lastAction = null; // { type, beforePages, beforeSelectedId }
    let permissionErrorOnSave = false;

    const el = (id) => document.getElementById(id);

    function setBanner(type, text, showCloseBtn = false) {
      const b = el("banner");
      b.className = "msg " + type;
      b.innerHTML = text;
      if (showCloseBtn) {
        const btn = document.createElement("button");
        btn.className = "closeTabBtn";
        btn.textContent = "é–‰ã˜ã¦Driveã«æˆ»ã‚‹";
        btn.addEventListener("click", () => {
          // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ window.close() ã§ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹
          alert("å®Ÿè£…æ™‚: window.close() ã§ã‚¿ãƒ–ã‚’é–‰ã˜ã¾ã™");
        });
        b.appendChild(btn);
      }
      b.style.display = "block";
      window.clearTimeout(setBanner._t);
      if (!showCloseBtn) {
        setBanner._t = window.setTimeout(() => (b.style.display = "none"), 4200);
      }
    }

    function renderHeaderState(label) {
      el("stateText").textContent = label;
    }

    function snapshotForUndo(type) {
      lastAction = {
        type,
        beforePages: structuredClone(pages),
        beforeSelectedId: selectedId
      };
    }

    function reorderById(arr, draggedId, targetId) {
      const from = arr.findIndex(x => x.id === draggedId);
      const to = arr.findIndex(x => x.id === targetId);
      if (from < 0 || to < 0) return arr;
      const copy = arr.slice();
      const [item] = copy.splice(from, 1);
      copy.splice(to, 0, item);
      return copy;
    }

    function rotate(id, delta) {
      const idx = pages.findIndex(p => p.id === id);
      if (idx < 0) return;
      snapshotForUndo("rotate");
      pages[idx].rotation = (pages[idx].rotation + delta + 360) % 360;
      renderAll();
      setBanner("warn", "å›è»¢ã—ã¾ã—ãŸï¼ˆ" + (delta > 0 ? "å³" : "å·¦") + "ï¼‰");
    }

    function deletePage(id) {
      const idx = pages.findIndex(p => p.id === id);
      if (idx < 0) return;
      snapshotForUndo("delete");
      pages.splice(idx, 1);
      if (!pages.length) selectedId = null;
      else if (!pages.some(p => p.id === selectedId)) selectedId = pages[Math.max(0, idx - 1)].id;
      renderAll();
      setBanner("bad", "ãƒšãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
    }

    function undo() {
      if (!lastAction) return;
      pages = structuredClone(lastAction.beforePages);
      selectedId = lastAction.beforeSelectedId;
      lastAction = null;
      renderAll();
      setBanner("warn", "Undoã—ã¾ã—ãŸï¼ˆç›´å‰1å›ï¼‰");
    }

    function renderList() {
      const list = el("thumbList");
      list.innerHTML = "";
      pages.forEach((p, idx) => {
        const row = document.createElement("div");
        row.className = "thumb";
        row.draggable = true;
        row.dataset.id = p.id;
        row.setAttribute("aria-selected", p.id === selectedId ? "true" : "false");

        row.addEventListener("click", () => {
          selectedId = p.id;
          renderAll();
        });

        row.addEventListener("dragstart", (e) => {
          e.dataTransfer.setData("text/plain", p.id);
          e.dataTransfer.effectAllowed = "move";
        });
        row.addEventListener("dragover", (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
        });
        row.addEventListener("drop", (e) => {
          e.preventDefault();
          const draggedId = e.dataTransfer.getData("text/plain");
          const targetId = p.id;
          if (!draggedId || draggedId === targetId) return;
          snapshotForUndo("reorder");
          pages = reorderById(pages, draggedId, targetId);
          renderAll();
        });

        const box = document.createElement("div");
        box.className = "pagebox";
        box.textContent = String(idx + 1);

        const rot = document.createElement("div");
        rot.className = "rotBadge";
        rot.textContent = p.rotation + "Â°";
        box.appendChild(rot);

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.innerHTML = '<div class="name">ãƒšãƒ¼ã‚¸ ' + (idx + 1) + '</div><div class="sub2">å…ƒ: ' + p.source + '</div>';

        const acts = document.createElement("div");
        const btnL = document.createElement("button");
        btnL.className = "iconbtn";
        btnL.title = "å·¦å›è»¢";
        btnL.textContent = "â†º";
        btnL.addEventListener("click", (ev) => { ev.stopPropagation(); rotate(p.id, -90); });

        const btnR = document.createElement("button");
        btnR.className = "iconbtn";
        btnR.title = "å³å›è»¢";
        btnR.textContent = "â†»";
        btnR.addEventListener("click", (ev) => { ev.stopPropagation(); rotate(p.id, +90); });

        const btnX = document.createElement("button");
        btnX.className = "iconbtn";
        btnX.title = "å‰Šé™¤";
        btnX.textContent = "âœ•";
        btnX.addEventListener("click", (ev) => { ev.stopPropagation(); deletePage(p.id); });

        acts.append(btnL, btnR, btnX);

        row.append(box, meta, acts);
        list.appendChild(row);
      });
    }

    function renderPreview() {
      const idx = pages.findIndex(p => p.id === selectedId);
      const p = pages[idx];

      el("undoBtn").disabled = !lastAction;

      if (!p) {
        el("pTitle").textContent = "ãƒšãƒ¼ã‚¸ -";
        el("sheetText").textContent = "-";
        el("rotBadge").textContent = "-";
        el("selInfo").textContent = "-";
        el("sheet").style.transform = "rotate(0deg)";
        return;
      }

      el("pTitle").textContent = "ãƒšãƒ¼ã‚¸ " + (idx + 1);
      el("sheetText").textContent = String(idx + 1);
      el("rotBadge").textContent = p.rotation + "Â°";
      el("selInfo").textContent = "ãƒšãƒ¼ã‚¸ " + (idx + 1) + "ï¼ˆå…ƒ: " + p.source + "ï¼‰";
      el("sheet").style.transform = "rotate(" + p.rotation + "deg)";
    }

    function renderAll() {
      renderList();
      renderPreview();
    }

    // --------- Save Flow ---------
    function buildOutputFilename(folderName) {
      const now = new Date();
      const pad = (n) => String(n).padStart(2, "0");
      const y = now.getFullYear();
      const m = pad(now.getMonth() + 1);
      const d = pad(now.getDate());
      const hh = pad(now.getHours());
      const mm = pad(now.getMinutes());
      return "æå‡ºç”¨_" + folderName + "_" + y + m + d + "_" + hh + mm + ".pdf";
    }

    function simulateSaveTo(folder) {
      const filename = buildOutputFilename(folder.name);
      renderHeaderState("ä¿å­˜å®Œäº†");
      setBanner("ok", "ä¿å­˜ã—ã¾ã—ãŸï¼š" + filename + "ï¼ˆä¿å­˜å…ˆ: " + folder.name + "ï¼‰", true);
    }

    function openFolderPicker() {
      const grid = el("folderGrid");
      grid.innerHTML = "";
      folders.forEach(f => {
        const card = document.createElement("div");
        card.className = "folder";
        card.innerHTML = '<div class="n">' + f.name + '</div><div class="p">' + f.path + '</div>';
        card.addEventListener("click", () => { closeModal(); simulateSaveTo(f); });
        grid.appendChild(card);
      });
      el("modalOverlay").style.display = "flex";
    }

    function closeModal() { el("modalOverlay").style.display = "none"; }

    function onSave() {
      if (!pages.length) { setBanner("bad", "ãƒšãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"); return; }
      renderHeaderState("ä¿å­˜ä¸­â€¦");

      setTimeout(() => {
        if (permissionErrorOnSave) {
          renderHeaderState("ä¿å­˜å¤±æ•—");
          setBanner("bad", "ã“ã®ãƒ•ã‚©ãƒ«ãƒ€ã«ä¿å­˜ã§ãã¾ã›ã‚“ï¼ˆPERMISSION_DENIEDï¼‰â†’ ãƒ•ã‚©ãƒ«ãƒ€é¸æŠã«åˆ‡æ›¿");
          openFolderPicker();
          return;
        }
        const originFolder = { id: "origin", name: el("folderName").textContent, path: "ãƒã‚¤ãƒ‰ãƒ©ã‚¤ãƒ–/æ¡ˆä»¶/..." };
        simulateSaveTo(originFolder);
      }, 650);
    }

    // --------- Events ---------
    el("rotateLeftBtn").addEventListener("click", () => selectedId && rotate(selectedId, -90));
    el("rotateRightBtn").addEventListener("click", () => selectedId && rotate(selectedId, +90));
    el("deleteBtn").addEventListener("click", () => selectedId && deletePage(selectedId));
    el("undoBtn").addEventListener("click", undo);

    el("saveBtn").addEventListener("click", onSave);

    el("resetBtn").addEventListener("click", () => {
      pages = structuredClone(initialPages);
      selectedId = pages[0]?.id ?? null;
      lastAction = null;
      permissionErrorOnSave = false;
      el("togglePermissionBtn").textContent = "æ¨©é™ã‚¨ãƒ©ãƒ¼: OFF";
      renderHeaderState("ç·¨é›†ä¸­");
      setBanner("warn", "ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
      renderAll();
    });

    el("togglePermissionBtn").addEventListener("click", () => {
      permissionErrorOnSave = !permissionErrorOnSave;
      el("togglePermissionBtn").textContent = "æ¨©é™ã‚¨ãƒ©ãƒ¼: " + (permissionErrorOnSave ? "ON" : "OFF");
      setBanner("warn", "æ¨©é™ã‚¨ãƒ©ãƒ¼ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼š" + (permissionErrorOnSave ? "ON" : "OFF"));
    });

    el("closeModalBtn").addEventListener("click", closeModal);
    el("modalOverlay").addEventListener("click", (e) => {
      if (e.target === el("modalOverlay")) closeModal();
    });

    // Init
    renderAll();
    renderHeaderState("ç·¨é›†ä¸­");
  </script>
</body>
</html>
