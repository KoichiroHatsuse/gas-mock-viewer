<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Googleãƒ‰ãƒ©ã‚¤ãƒ–æœŸé™ä»˜ããƒªãƒ³ã‚¯é€ä¿¡</title>
  <style>
    :root {
      --bg: #f4f5f7;
      --card: #ffffff;
      --line: #e1e4e8;
      --text: #24292f;
      --muted: #656d76;
      --blue: #0969da;
      --blue-light: #ddf4ff;
      --red: #cf222e;
      --green: #1a7f37;
      --green-light: #dafbe1;
      --yellow: #9a6700;
      --yellow-light: #fff8c5;
      --radius: 8px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* Header */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      background: var(--card);
      border-bottom: 1px solid var(--line);
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .header h1 {
      font-size: 16px;
      font-weight: 600;
    }
    .header-icon {
      font-size: 20px;
    }
    .back-link {
      color: var(--blue);
      text-decoration: none;
      font-size: 14px;
    }
    .back-link:hover {
      text-decoration: underline;
    }

    /* Banner */
    .banner {
      display: none;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 500;
    }
    .banner.show { display: block; }
    .banner.ok { background: var(--green-light); color: var(--green); }
    .banner.warn { background: var(--yellow-light); color: var(--yellow); }
    .banner.bad { background: #ffebe9; color: var(--red); }

    /* Main Layout */
    .main {
      padding: 16px;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Case Info Header */
    .case-header {
      background: var(--blue-light);
      border: 1px solid var(--blue);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 16px;
    }
    .case-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .case-email {
      font-size: 14px;
      color: var(--muted);
    }

    /* Two Column Layout with Resizable */
    .two-column {
      display: flex;
      gap: 0;
      margin-bottom: 16px;
      min-height: 400px;
    }
    .left-panel {
      width: 320px;
      min-width: 250px;
      max-width: 500px;
      flex-shrink: 0;
    }
    .resize-handle {
      width: 8px;
      background: var(--line);
      cursor: col-resize;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .resize-handle:hover {
      background: var(--blue);
    }
    .resize-handle::after {
      content: 'â‹®';
      color: var(--muted);
      font-size: 14px;
    }
    .resize-handle:hover::after {
      color: white;
    }
    .right-panel {
      flex: 1;
      min-width: 300px;
    }
    @media (max-width: 800px) {
      .two-column {
        flex-direction: column;
      }
      .left-panel {
        width: 100%;
        max-width: none;
      }
      .resize-handle {
        display: none;
      }
    }

    /* Panel */
    .panel {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      overflow: hidden;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    .panel-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--line);
      font-weight: 600;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }
    .panel-body {
      padding: 12px;
      flex: 1;
      overflow: auto;
    }

    /* Folder Tree */
    .folder-tree {
      font-size: 14px;
    }
    .tree-item {
      display: flex;
      align-items: center;
      padding: 6px 8px;
      border-radius: 4px;
      cursor: pointer;
      user-select: none;
    }
    .tree-item:hover {
      background: var(--bg);
    }
    .tree-folder {
      font-weight: 500;
    }
    .tree-folder-icon {
      margin-right: 8px;
      transition: transform 0.2s;
    }
    .tree-folder-icon.collapsed {
      transform: rotate(-90deg);
    }
    .tree-children {
      margin-left: 20px;
    }
    .tree-children.collapsed {
      display: none;
    }
    .tree-file {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 4px;
      cursor: pointer;
    }
    .tree-file:hover {
      background: var(--bg);
    }
    .tree-file.selected {
      background: var(--blue-light);
    }
    .tree-file input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--blue);
    }
    .tree-file-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Preview Tabs */
    .preview-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      padding: 8px 12px;
      border-bottom: 1px solid var(--line);
      background: var(--bg);
      min-height: 44px;
    }
    .preview-tab {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 4px;
      font-size: 13px;
      cursor: pointer;
      max-width: 150px;
    }
    .preview-tab:hover {
      border-color: var(--blue);
    }
    .preview-tab.active {
      background: var(--blue-light);
      border-color: var(--blue);
    }
    .preview-tab-name {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .preview-tab-close {
      font-size: 14px;
      color: var(--muted);
      line-height: 1;
    }
    .preview-tab-close:hover {
      color: var(--red);
    }
    .preview-empty {
      color: var(--muted);
      font-size: 13px;
      padding: 8px 0;
    }

    /* Preview Area */
    .preview-area {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 300px;
      background: var(--bg);
      border-radius: var(--radius);
      color: var(--muted);
      font-size: 14px;
      margin: 12px;
      flex: 1;
    }
    .preview-content {
      text-align: center;
    }
    .preview-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }

    /* Send Form */
    .send-form {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 16px;
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-group:last-child {
      margin-bottom: 0;
    }
    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 6px;
      color: var(--muted);
    }
    .form-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      font-size: 14px;
    }
    .form-input:focus {
      outline: none;
      border-color: var(--blue);
      box-shadow: 0 0 0 3px var(--blue-light);
    }
    .form-input:disabled {
      background: var(--bg);
      color: var(--muted);
    }
    .form-textarea {
      min-height: 120px;
      resize: vertical;
      font-family: inherit;
    }
    .form-static {
      padding: 8px 0;
      font-size: 14px;
    }

    /* Buttons */
    .btn {
      padding: 8px 16px;
      border-radius: var(--radius);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--line);
      background: var(--card);
      color: var(--text);
    }
    .btn:hover { background: var(--bg); }
    .btn-primary {
      background: var(--blue);
      color: white;
      border-color: var(--blue);
    }
    .btn-primary:hover { background: #0860ca; }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Actions */
    .actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 200;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: var(--card);
      border-radius: var(--radius);
      padding: 24px;
      max-width: 400px;
      width: 90%;
    }
    .modal-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
    }
    .modal-body {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 20px;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* Preview Image */
    .preview-image {
      max-width: 100%;
      max-height: 280px;
      object-fit: contain;
      cursor: zoom-in;
      border-radius: var(--radius);
      transition: transform 0.2s;
    }
    .preview-image:hover {
      transform: scale(1.02);
    }

    /* Image Zoom Modal */
    .image-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      z-index: 300;
      align-items: flex-start;
      justify-content: center;
      overflow-y: auto;
      padding: 40px 20px;
    }
    .image-modal-overlay.show { display: flex; }
    .image-modal-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      align-items: center;
      padding-bottom: 40px;
    }
    .image-modal-page {
      max-width: 90vw;
      background: white;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .image-modal-page-number {
      color: white;
      font-size: 14px;
      margin-top: 8px;
      opacity: 0.7;
    }
    .image-modal-close {
      position: fixed;
      top: 20px;
      right: 20px;
      color: white;
      font-size: 32px;
      cursor: pointer;
      z-index: 301;
      background: rgba(0,0,0,0.5);
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .image-modal-close:hover {
      background: rgba(0,0,0,0.8);
    }
    .image-modal-hint {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      font-size: 14px;
      background: rgba(0,0,0,0.5);
      padding: 8px 16px;
      border-radius: 20px;
      z-index: 301;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <span class="header-icon">ğŸ“¤</span>
      <h1>æ›¸é¡é€ä¿¡ã‚·ã‚¹ãƒ†ãƒ </h1>
    </div>
    <a id="backLink" href="#" target="_top" class="back-link">ä¸€è¦§ã«æˆ»ã‚‹</a>
  </header>

  <!-- Banner -->
  <div id="banner" class="banner"></div>

  <!-- Main -->
  <main class="main">
    <!-- Case Header (Fixed - No Search) -->
    <div class="case-header">
      <div class="case-title">
        <span>ğŸ“</span>
        <span>æ¡ˆä»¶: <span id="caseNumber">A-12345</span> - <span id="bankName">ãã‚‰ã¼ã—éŠ€è¡Œ</span></span>
      </div>
      <div class="case-email">é€ä¿¡å…ˆ: <span id="recipientEmail">loan@kiraboshibank.co.jp</span>ï¼ˆ<span id="recipientName">èè³‡æ‹…å½“è€…</span>ï¼‰</div>
    </div>

    <!-- Two Column: Folder Tree + Preview -->
    <div class="two-column">
      <!-- Left Panel: Folder Tree -->
      <div class="left-panel">
        <div class="panel">
          <div class="panel-header">
            <span>ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</span>
            <span id="fileCount" style="color: var(--muted); font-weight: normal;">0/10</span>
          </div>
          <div class="panel-body">
            <div id="folderTree" class="folder-tree"></div>
          </div>
        </div>
      </div>

      <!-- Resize Handle -->
      <div class="resize-handle" id="resizeHandle"></div>

      <!-- Right Panel: Preview with Tabs -->
      <div class="right-panel">
        <div class="panel">
          <div class="panel-header">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
          <div id="previewTabs" class="preview-tabs">
            <span class="preview-empty">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</span>
          </div>
          <div id="previewArea" class="preview-area">
            <div class="preview-content">
              <div class="preview-icon">ğŸ“„</div>
              <div>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã™ã‚‹ã¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Send Form -->
    <div class="send-form">
      <div class="form-group">
        <label class="form-label">å…±æœ‰æœŸé™</label>
        <div class="form-static" id="expirationDate">7æ—¥å¾Œï¼ˆè¨ˆç®—ä¸­...ï¼‰</div>
      </div>
      <div class="form-group">
        <label class="form-label">ä»¶å</label>
        <input type="text" id="emailSubject" class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">æœ¬æ–‡</label>
        <textarea id="emailBody" class="form-input form-textarea"></textarea>
      </div>
    </div>

    <!-- Actions -->
    <div class="actions">
      <button id="cancelBtn" class="btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="sendBtn" class="btn btn-primary" disabled>é€ä¿¡</button>
    </div>
  </main>

  <!-- Confirm Modal -->
  <div id="confirmModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-title">é€ä¿¡ç¢ºèª</div>
      <div class="modal-body" id="confirmBody">
        é¸æŠã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’é€ä¿¡ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ
      </div>
      <div class="modal-actions">
        <button id="confirmCancel" class="btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="confirmOk" class="btn btn-primary">é€ä¿¡ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- Image Zoom Modal (PDF with multiple pages) -->
  <div id="imageModal" class="image-modal-overlay">
    <span id="imageModalClose" class="image-modal-close">Ã—</span>
    <div id="imageModalContainer" class="image-modal-container">
      <!-- Pages will be inserted here -->
    </div>
    <div class="image-modal-hint">â†• ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ä»–ã®ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º</div>
  </div>

  <script>
    // ========================================
    // Mock Data
    // ========================================
    const MOCK_CASE = {
      caseNumber: 'A-12345',
      bankName: 'ãã‚‰ã¼ã—éŠ€è¡Œ',
      recipientEmail: 'loan@kiraboshibank.co.jp',
      recipientName: 'èè³‡æ‹…å½“è€…',
    };

    const MOCK_FOLDER_TREE = {
      name: 'A-12345',
      type: 'folder',
      expanded: true,
      children: [
        {
          name: 'ç”³è¾¼æ›¸é¡',
          type: 'folder',
          expanded: true,
          children: [
            { id: '1', name: 'å¥‘ç´„æ›¸.pdf', type: 'file' },
            { id: '2', name: 'æœ¬äººç¢ºèªæ›¸é¡.pdf', type: 'file' },
            { id: '3', name: 'å§”ä»»çŠ¶.pdf', type: 'file' },
          ],
        },
        {
          name: 'å¯©æŸ»æ›¸é¡',
          type: 'folder',
          expanded: false,
          children: [
            { id: '4', name: 'åå…¥è¨¼æ˜æ›¸.pdf', type: 'file' },
            { id: '5', name: 'ç‰©ä»¶è³‡æ–™.pdf', type: 'file' },
            { id: '6', name: 'ç™»è¨˜ç°¿è¬„æœ¬.pdf', type: 'file' },
          ],
        },
        {
          name: 'å¥‘ç´„é–¢é€£',
          type: 'folder',
          expanded: false,
          children: [
            { id: '7', name: 'é‡è¦äº‹é …èª¬æ˜æ›¸.pdf', type: 'file' },
            { id: '8', name: 'å£²è²·å¥‘ç´„æ›¸.pdf', type: 'file' },
          ],
        },
        { id: '9', name: 'æ¡ˆä»¶ã‚µãƒãƒªãƒ¼.xlsx', type: 'file' },
        { id: '10', name: 'ãƒ¡ãƒ¢.txt', type: 'file' },
      ],
    };

    const EMAIL_TEMPLATE = `{recipientName} æ§˜

ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
æ ªå¼ä¼šç¤¾ã„ãˆãƒ¼ã‚‹ã®æ‹…å½“è€…ã§ã™ã€‚

æ›¸é¡ã‚’é€ä»˜ã„ãŸã—ã¾ã™ã®ã§ã€ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‚ˆã‚Šã”ç¢ºèªãã ã•ã„ã€‚

ã€é€ä¿¡ãƒ•ã‚©ãƒ«ãƒ€ã€‘
é€ä¿¡_{date}_{bankName}
{fileList}

ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã€‘
{googleDriveLink}

â€»ãƒªãƒ³ã‚¯ã®æœ‰åŠ¹æœŸé™: {expirationDate}
â€»æœŸé™ã‚’éãã‚‹ã¨ã‚¢ã‚¯ã‚»ã‚¹ã§ããªããªã‚Šã¾ã™

ã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚

---
æ ªå¼ä¼šç¤¾ã„ãˆãƒ¼ã‚‹
ãƒ€ãƒ³ãƒ‰ãƒªæ¨é€²éƒ¨`;

    // ========================================
    // Sample Image (Base64)
    // ========================================
    const SAMPLE_IMAGE_BASE64 = 'https://www.npa.go.jp/policies/application/license_renewal/img/license.jpg';

    // ========================================
    // State
    // ========================================
    let selectedFileIds = new Set();
    let activePreviewId = null;
    let allFiles = [];

    // Collect all files from tree
    function collectFiles(node) {
      if (node.type === 'file') {
        allFiles.push(node);
      }
      if (node.children) {
        node.children.forEach(child => collectFiles(child));
      }
    }
    collectFiles(MOCK_FOLDER_TREE);

    // ========================================
    // DOM Elements
    // ========================================
    const $ = (id) => document.getElementById(id);
    const folderTree = $('folderTree');
    const fileCount = $('fileCount');
    const previewTabs = $('previewTabs');
    const previewArea = $('previewArea');
    const expirationDateEl = $('expirationDate');
    const emailSubject = $('emailSubject');
    const emailBody = $('emailBody');
    const cancelBtn = $('cancelBtn');
    const sendBtn = $('sendBtn');
    const banner = $('banner');
    const confirmModal = $('confirmModal');
    const confirmBody = $('confirmBody');
    const confirmCancel = $('confirmCancel');
    const confirmOk = $('confirmOk');
    const resizeHandle = $('resizeHandle');
    const leftPanel = document.querySelector('.left-panel');

    // ========================================
    // Functions
    // ========================================
    function showBanner(message, type) {
      banner.textContent = message;
      banner.className = 'banner show ' + type;
      setTimeout(() => {
        banner.classList.remove('show');
      }, 4000);
    }

    function formatDate(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    function getExpirationDate() {
      const date = new Date();
      date.setDate(date.getDate() + 7);
      return date;
    }

    function renderFolderTree() {
      folderTree.innerHTML = renderNode(MOCK_FOLDER_TREE, 0);
      attachTreeListeners();
    }

    function renderNode(node, depth) {
      if (node.type === 'folder') {
        const isExpanded = node.expanded;
        return `
          <div class="tree-item tree-folder" data-name="${node.name}" style="padding-left: ${depth * 12}px">
            <span class="tree-folder-icon ${isExpanded ? '' : 'collapsed'}">â–¼</span>
            <span>ğŸ“ ${node.name}</span>
          </div>
          <div class="tree-children ${isExpanded ? '' : 'collapsed'}" data-folder="${node.name}">
            ${node.children ? node.children.map(child => renderNode(child, depth + 1)).join('') : ''}
          </div>
        `;
      } else {
        const isSelected = selectedFileIds.has(node.id);
        const icon = node.name.endsWith('.pdf') ? 'ğŸ“„' : node.name.endsWith('.xlsx') ? 'ğŸ“Š' : 'ğŸ“';
        return `
          <div class="tree-file ${isSelected ? 'selected' : ''}" data-id="${node.id}" style="padding-left: ${depth * 12 + 8}px">
            <input type="checkbox" ${isSelected ? 'checked' : ''}>
            <span>${icon}</span>
            <span class="tree-file-name">${node.name}</span>
          </div>
        `;
      }
    }

    function attachTreeListeners() {
      // Folder toggle
      folderTree.querySelectorAll('.tree-folder').forEach(folder => {
        folder.addEventListener('click', () => {
          const name = folder.dataset.name;
          const children = folderTree.querySelector(`.tree-children[data-folder="${name}"]`);
          const icon = folder.querySelector('.tree-folder-icon');
          if (children) {
            children.classList.toggle('collapsed');
            icon.classList.toggle('collapsed');
          }
        });
      });

      // File toggle
      folderTree.querySelectorAll('.tree-file').forEach(file => {
        file.addEventListener('click', (e) => {
          const id = file.dataset.id;
          toggleFile(id);
        });
      });
    }

    function toggleFile(id) {
      if (selectedFileIds.has(id)) {
        selectedFileIds.delete(id);
        if (activePreviewId === id) {
          const remaining = Array.from(selectedFileIds);
          activePreviewId = remaining.length > 0 ? remaining[remaining.length - 1] : null;
        }
      } else {
        if (selectedFileIds.size >= 10) {
          showBanner('æœ€å¤§10ä»¶ã¾ã§ã—ã‹é¸æŠã§ãã¾ã›ã‚“', 'warn');
          return;
        }
        selectedFileIds.add(id);
        activePreviewId = id;
      }
      updateUI();
    }

    function updateUI() {
      renderFolderTree();
      updateFileCount();
      updatePreviewTabs();
      updatePreview();
      updateEmailBody();
      updateSendButton();
    }

    function updateFileCount() {
      const count = selectedFileIds.size;
      fileCount.textContent = `${count}/10`;
      fileCount.style.color = count > 0 ? 'var(--blue)' : 'var(--muted)';
    }

    function updatePreviewTabs() {
      if (selectedFileIds.size === 0) {
        previewTabs.innerHTML = '<span class="preview-empty">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</span>';
        return;
      }

      const selectedFiles = allFiles.filter(f => selectedFileIds.has(f.id));
      previewTabs.innerHTML = selectedFiles.map(file => `
        <div class="preview-tab ${activePreviewId === file.id ? 'active' : ''}" data-id="${file.id}">
          <span class="preview-tab-name">${file.name}</span>
          <span class="preview-tab-close" data-id="${file.id}">Ã—</span>
        </div>
      `).join('');

      // Tab click handlers
      previewTabs.querySelectorAll('.preview-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
          if (e.target.classList.contains('preview-tab-close')) {
            const id = e.target.dataset.id;
            toggleFile(id);
          } else {
            activePreviewId = tab.dataset.id;
            updatePreviewTabs();
            updatePreview();
          }
        });
      });
    }

    function updatePreview() {
      if (!activePreviewId) {
        previewArea.innerHTML = `
          <div class="preview-content">
            <div class="preview-icon">ğŸ“„</div>
            <div>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã™ã‚‹ã¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
          </div>
        `;
        return;
      }

      const file = allFiles.find(f => f.id === activePreviewId);
      if (!file) return;

      // PDFãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚µãƒ³ãƒ—ãƒ«ç”»åƒã‚’è¡¨ç¤ºï¼ˆã‚¯ãƒªãƒƒã‚¯ã§æ‹¡å¤§ï¼‰
      if (file.name.endsWith('.pdf')) {
        previewArea.innerHTML = `
          <div class="preview-content">
            <div style="font-weight: 500; margin-bottom: 12px;">${file.name}</div>
            <img src="${SAMPLE_IMAGE_BASE64}" alt="${file.name}" class="preview-image" onclick="openImageModal(this.src, '${file.name}')">
            <div style="color: var(--muted); margin-top: 8px; font-size: 12px;">ã‚¯ãƒªãƒƒã‚¯ã§æ‹¡å¤§ï¼ˆè¤‡æ•°ãƒšãƒ¼ã‚¸å¯¾å¿œï¼‰</div>
          </div>
        `;
      } else {
        const icon = file.name.endsWith('.xlsx') ? 'ğŸ“Š' : 'ğŸ“';
        previewArea.innerHTML = `
          <div class="preview-content">
            <div class="preview-icon">${icon}</div>
            <div style="font-weight: 500; margin-bottom: 8px;">${file.name}</div>
            <div style="color: var(--muted);">ï¼ˆã“ã®ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼éå¯¾å¿œã§ã™ï¼‰</div>
          </div>
        `;
      }
    }

    function openImageModal(src, fileName) {
      const imageModal = document.getElementById('imageModal');
      const imageModalContainer = document.getElementById('imageModalContainer');

      // ãƒ¢ãƒƒã‚¯ç”¨: PDFã®è¤‡æ•°ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¾ï¼ˆåŒã˜ç”»åƒã‚’3ãƒšãƒ¼ã‚¸åˆ†è¡¨ç¤ºï¼‰
      const pageCount = 3;
      let pagesHtml = '';
      for (let i = 1; i <= pageCount; i++) {
        pagesHtml += `
          <div style="text-align: center;">
            <img src="${src}" alt="${fileName} - ãƒšãƒ¼ã‚¸ ${i}" class="image-modal-page">
            <div class="image-modal-page-number">${fileName} - ${i} / ${pageCount} ãƒšãƒ¼ã‚¸</div>
          </div>
        `;
      }
      imageModalContainer.innerHTML = pagesHtml;
      imageModal.classList.add('show');
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã„ãŸã‚‰ä¸€ç•ªä¸Šã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      imageModal.scrollTop = 0;
    }

    function closeImageModal() {
      const imageModal = document.getElementById('imageModal');
      imageModal.classList.remove('show');
    }

    function updateEmailBody() {
      const selectedFiles = allFiles.filter(f => selectedFileIds.has(f.id));
      const fileListText = selectedFiles.length > 0
        ? selectedFiles.map(f => `ãƒ»${f.name}`).join('\n')
        : 'ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«æœªé¸æŠï¼‰';

      const expDate = getExpirationDate();
      const today = new Date();
      // ãƒ¢ãƒƒã‚¯ç”¨ã®Googleãƒ‰ãƒ©ã‚¤ãƒ–ãƒªãƒ³ã‚¯
      const mockDriveLink = `https://drive.google.com/drive/folders/XXXXXXX_é€ä¿¡_${formatDate(today)}_${MOCK_CASE.bankName}`;

      const body = EMAIL_TEMPLATE
        .replace('{recipientName}', MOCK_CASE.recipientName)
        .replace('{date}', formatDate(today))
        .replace('{bankName}', MOCK_CASE.bankName)
        .replace('{fileList}', fileListText)
        .replace('{googleDriveLink}', mockDriveLink)
        .replace('{expirationDate}', formatDate(expDate));

      emailBody.value = body;
    }

    function updateSendButton() {
      sendBtn.disabled = selectedFileIds.size === 0;
    }

    function showConfirmModal() {
      const selectedFiles = allFiles.filter(f => selectedFileIds.has(f.id));
      const today = new Date();
      confirmBody.innerHTML = `
        <div style="margin-bottom: 12px;">ä»¥ä¸‹ã®å†…å®¹ã§é€ä¿¡ã—ã¾ã™ï¼š</div>
        <div style="background: var(--bg); padding: 12px; border-radius: var(--radius); margin-bottom: 12px;">
          <div style="font-weight: 500; margin-bottom: 8px;">ğŸ“ é€ä¿¡ãƒ•ã‚©ãƒ«ãƒ€: é€ä¿¡_${formatDate(today)}_${MOCK_CASE.bankName}</div>
          <div style="font-size: 13px; color: var(--muted);">
            ${selectedFiles.map(f => `<div>ãƒ»${f.name}</div>`).join('')}
          </div>
        </div>
        <div>é€ä¿¡å…ˆ: ${MOCK_CASE.recipientEmail}</div>
      `;
      confirmModal.classList.add('show');
    }

    function hideConfirmModal() {
      confirmModal.classList.remove('show');
    }

    function sendFiles() {
      hideConfirmModal();
      showBanner('é€ä¿¡å‡¦ç†ä¸­...', 'warn');

      setTimeout(() => {
        const today = new Date();
        showBanner(`é€ä¿¡å®Œäº†: é€ä¿¡_${formatDate(today)}_${MOCK_CASE.bankName}`, 'ok');
        selectedFileIds.clear();
        activePreviewId = null;
        updateUI();
      }, 1500);
    }

    function resetForm() {
      selectedFileIds.clear();
      activePreviewId = null;
      updateUI();
      showBanner('é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'ok');
    }

    // ========================================
    // Resize Handle
    // ========================================
    let isResizing = false;

    resizeHandle.addEventListener('mousedown', (e) => {
      isResizing = true;
      document.body.style.cursor = 'col-resize';
      document.body.style.userSelect = 'none';
    });

    document.addEventListener('mousemove', (e) => {
      if (!isResizing) return;
      const containerRect = document.querySelector('.two-column').getBoundingClientRect();
      const newWidth = e.clientX - containerRect.left;
      if (newWidth >= 250 && newWidth <= 500) {
        leftPanel.style.width = newWidth + 'px';
      }
    });

    document.addEventListener('mouseup', () => {
      isResizing = false;
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
    });

    // ========================================
    // Event Listeners
    // ========================================
    cancelBtn.addEventListener('click', resetForm);
    sendBtn.addEventListener('click', showConfirmModal);
    confirmCancel.addEventListener('click', hideConfirmModal);
    confirmOk.addEventListener('click', sendFiles);
    confirmModal.addEventListener('click', (e) => {
      if (e.target === confirmModal) hideConfirmModal();
    });

    // Image modal events
    document.getElementById('imageModalClose').addEventListener('click', closeImageModal);
    document.getElementById('imageModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('imageModal')) closeImageModal();
    });

    // ========================================
    // Initialize
    // ========================================
    google.script.run
      .withSuccessHandler(function(url) {
        document.getElementById('backLink').href = url + '?page=index';
      })
      .getWebAppUrl();

    // Set initial values
    const expDate = getExpirationDate();
    expirationDateEl.textContent = `7æ—¥å¾Œï¼ˆ${formatDate(expDate)}ï¼‰`;
    emailSubject.value = `æ›¸é¡é€ä»˜ã®ã”é€£çµ¡ - ${MOCK_CASE.caseNumber}`;

    // Render initial UI
    renderFolderTree();
    updateEmailBody();
  </script>
</body>
</html>
